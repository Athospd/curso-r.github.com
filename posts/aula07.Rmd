---
title: "Aula 07 - Modelando"
output:
  html_document:
    number_sections: yes
    toc_depth: 2
    toc: yes
date : 2015-02-02
---

```{r, echo=FALSE, warning=FALSE, message=FALSE}
library(pander)
library(ggplot2)
library(magrittr)
library(tidyr)
library(dplyr)
panderOptions("table.style", "rmarkdown")
```

# Regressão Linear e ANOVA

O R tem todo o ferramental necessário para fazer modelos lineares, a começar pelo modelo de regressão linear normal.

Para ilustrar, vamos utilizar a base de dados `mtcars` que vem no R.

Cada uma das 32 linhas da base `mtcars` representa um carro. A variável `mpg` é o consumo de combustível em milhas por galão (~3.76 Litros) e iremos tentar explicá-la pelas demais características dos veículos. 

## Um pouco de descritiva

### Univariada
```{r}
# os dados
head(mtcars)

# banco de dados das variáveis contínuas no formato "longo"
mtcars_long <- mtcars %>%  
  select(mpg, disp:qsec) %>%
  gather(var_continuas) 

# medidas resumo para variáveis contínuas
mtcars_long %>%
  group_by(var_continuas) %>%
  summarise("N" = n(),
            "Missing" = sum(is.na(value)),
            "Media" = mean(value),
            "DesvPad" = sd(value),
            "Minimo" = min(value),
            "Q1" = quantile(value, 0.25),
            "Mediana" = quantile(value, 0.50),
            "Q3" = quantile(value, 0.75),
            "Maximo" = max(value)) %>%
  mutate_each(funs(round(.,1)), -var_continuas)

# boxplots
mtcars_long %>%
  ggplot() +
  geom_boxplot(aes(x=1, y = value)) +
  facet_wrap(~var_continuas, scales = "free") 

# frequencias de variáveis categóricas
mtcars_freq <- mtcars %>%
  select(cyl, vs:carb) %>%
  gather(vars_categoricas) %>%
  rename(categoria = value) %>%
  group_by(vars_categoricas, categoria) %>%
  summarise(freq = n()) %>%
  group_by(vars_categoricas) %>%
  mutate(prop = freq/sum(freq),
         prop_txt = (prop*100) %>% round(0) %>% paste0("%"))

mtcars_freq

# Gráfico de barras
mtcars_freq %>%
  ggplot() +
  geom_bar(aes(x=categoria, y = freq), position = "dodge", stat = "identity") +
  facet_wrap(~vars_categoricas, scales="free")  
```

### Versus `mpg`

```{r}
# Matriz de correlação linear
mtcars %>%  
  select(mpg, disp:qsec) %>%
  cor %>%
  round(2) 

# Matriz de dispersão
pairs(mtcars %>%  
  select(mpg, disp:qsec))
```


## Regressão linear
A função que ajusta modelo linear normal no R é `lm()`. Você especifica o banco de dados e a fórmula com as variáveis que você deseja associar.

```{r, eval=FALSE}
ajuste <- lm(resposta ~ explicativas, data = meus_dados)
```

O objeto `ajuste` contém todos os resultados e com a ajuda de alguns comandos, você extrai tudo o que é interessante.

Exemplo:
```{r}
ajuste_lm <- lm(mpg ~ wt, data = mtcars)

ajuste_lm
```

No código acima temos `mpg` explicado por `wt`. A saída do `lm()` mostra qual foi a chamada do modelo e os coeficientes ajustados. Como visto na análise descritiva, há uma clara associação linear e negativa entre as variáveis, justificando o parâmetro negativo `wt = -5.344`. A função `coeficients()` ou `coef()` nos fornece os coeficientes ajustados.

Gráfico da reta ajustada:
```{r}
# extrai os coeficientes ajustados
coeficientes <- coef(ajuste_lm)

ggplot(mtcars) +
  geom_point(aes(x = wt, y = mpg)) +
  geom_abline(intercept = coeficientes[1], slope = coeficientes[2])
```

**summary()**

A função `summary()` é uma função genérica que geralmente devolve um resumo de informações úteis de praticamente qualquer classe de objetos. Para objetos `lm()` ela devolve:

1. Chamada do modelo
2. Medidas resumo dos resíduos
3. Tabela de coeficientes, desvios padrão e testes T para hipótese nula de parâmetros iguais a zero.
4. Média dos quadrados do resíduo e os respectivos graus de liberdade; $R^2$ e $R^2$ ajustado da regressão; Estatística F para qualidade do ajuste (comparação com o modelo com apenas o intercepto).

```{r, eval=FALSE}
summary(ajuste_lm)
```

![summary lm](summary_lm.png)

**plot()**

A função `plot()` constrói gráficos úteis para diagnóstico do modelo.

```{r}
# opção para mostrar 4 gráficos em uma mesma figura
par(mfrow = c(2,2))

# gráficos de diagnóstico do modelo ajuste_lm
plot(ajuste_lm)

# retorna ao normal
par(mfrow = c(1,1))
```

**anova()**

Uma parte importante da modelagem é a redução de modelos. A função `anova()` compara dois (ou mais) modelos encaixados por meio da estatística F (por padrão), especialmente indicadas para modelos lineares normais. Caso seja passada apenas um ajuste à função, ela devolve a tabela de ANOVA (termos testados sequencialmente).

```{r}
# modelo nulo, com apenas o intercepto
ajuste_lm_nulo <- lm(mpg ~ 1, data = mtcars)

# modelo com wt e cyl
ajuste_lm2 <- lm(mpg ~ wt + cyl, data = mtcars)

# compara o modelo com wt com o modelo nulo
anova(ajuste_lm_nulo, ajuste_lm)

# Tabela de ANOVA, testa os termos sequencialmente
anova(ajuste_lm2)
```

A o valor-p = 0.001064 indica que o modelo com `wt + cyl` trás melhorias significantes no poder explicativo do modelo quando comparado ao modelo com apenas `wt`. 

**demais comandos**

Outros comandos úteis são:

```{r, eval=TRUE, echo=FALSE, results='asis'}
comandos_uteis_lm <- data.frame("Função" = c("confint()",
                                             "resid()",
                                             "fitted()",
                                             "AIC()",
                                             "model.matrix()"),
                                "Descrição" = c("Intervalo de confiança para os parâmetros",
                                                "Resíduos do modelo",
                                                "Valores ajustados",
                                                "Critério de informação de Akaike",
                                                "Matriz de planejamento (matriz X) do modelo"))
comandos_uteis_lm %>% pander
```

## Fórmulas

## Seleção de variáveis

# Modelos Lineares Generalizados

A regressão linear normal pode ser inadequada quando a distribuição de $Y_i$ é assimétrica, representa
dados de contagens ou então dados binários. Para lidar com esse problema, McCulagh e Nelder estenderam
a família de distribuições para ajuste da regressão para distribuições da _família exponencial_. Tal
família inclui as distribuições `normal`, `poisson`, `gama`, `normal inversa` e `binomial` (incluindo
`bernoulli`), entre outras. Também existe uma forma de adaptar os MLG para a distribuição `binomial negativa`.

A definição dos MLG é dada por

$$
Y_i \sim F(\mu_i, \phi)
$$

$$
\mu_i = g^{-1}(\alpha + \beta_1 x_{i1} + \beta_p x_{ip})
$$

O parâmetro $\phi$ é o parâmetro de precisão (inverso do parâmetro de dispersão) e $g$ é a _função de ligação_, que geralmente tem o papel de jogar o intervalo de vação de $\mu_i$ (espaço paramétrico) no intervalo $(-\inf, \inf)$.

## Como ajustar um modelo de regressão

Para ajustar um modelo linear generalizado, basta utilizar a função `glm` e informar, além da fórmula, a família de distribuições da resposta.

## Famílias de distribuição

```{r, echo=FALSE}
x <- data_frame(Family=c('gaussian', 'binomial', 'poisson', 'Gamma', 'inverse.gaussian', 'quasi'),
                Link=c('identity', 'logit, probit, cloglog', 'log, identity, sqrt', 'inverse, identity, log', '1/mu^2', 'definido pelo usuário'))
x %>% pander
```

Os resultados dos modelos `glm` estão praticamente no mesmo formato que os resultados da função `lm`,
a diferença é que o valor-p é assintótico nesse caso.

## Análise de resíduos

Na página [do professor Gilberto](http://www.ime.usp.br/~giapaula/textoregressao.htm) pode-se obter o livro dele sobre GLM e também vários comandos para realizar análises de diagnóstico dos modelos ajustados.

## Exemplo: Regressão logística

**Dados**: Coalitions (ver lab 02)

```{r}
data(wto_data, package='abjutils')
data(wto_dyad_sample, package='abjutils')

aux <- wto_dyad_sample %>%
  select(ccode1, ccode2, year) %>%
  gather(lab_ccode, ccode, -year) %>%
  distinct(year, ccode) %>%
  mutate_each(funs(as.character))

##
load('~/Projects/wto_redes/data/dados_gerais_imput.RData')
d <- read.csv2('~/Projects/wto_redes/data/banco_v16.csv', as.is=T)
d %>%
  mutate(lpib=log(pwt_rgdp), entar=ifelse(entar>0, 1, 0)) %>%
  filter(year >= 1982, year <= 2006) %>%
  ggplot() + 
  geom_boxplot(aes(x=factor(entar), y=lpib))
wto_data$year <- as.character(dados_gerais_imput$year)

# atualizar dados gerais imput nos dois projetos
# adicionar year no wto_data

##

d_reg <- wto_data %>%
  mutate(year_num=as.numeric(as.character(year))) %>%
  filter(year_num >= 1982, year_num <= 2006) %>%
  mutate(pib=abs(pib)) %>%
  mutate(ccode=as.character(ccode)) %>%
  left_join(aux, c('ccode', 'year')) %>%
  mutate(resp=ifelse(is.na(lab_ccode), 0, 1)) %>%
  select(-lab_ccode) %>%
  mutate(lpib=log10(pib))
```

```{r}
fit_model <- glm(formula = resp ~ leste_oeste + norte_sul + lpib + pib_per_capita + democracia, 
                 family = binomial, 
                 data = d_reg)

fit_model

summary(fit_model)
```


# Modelos de Sobrevivência

## Kaplan-Meier

## Análise de resíduos

## Testes de hipóteses

# Árvore de Decisão

# Análise de Agrupamento

# Análise de Componentes Principais

# Demais tópicos

- Dados longitudinais
- Séries temporais
- Dados categorizados
- GAM/GAMLSS
- Inferência Bayesiana
- Processos estocásticos
- Reamostragem

# Referências

http://www-bcf.usc.edu/~gareth/ISL/ISLR%20First%20Printing.pdf

http://web.stanford.edu/~hastie/local.ftp/Springer/OLD/ESLII_print4.pdf

http://www.ime.usp.br/~giapaula/texto_2013.pdf

Colosimo, E.A. e Giolo, S.R. (2006) Análise de sobrevivência aplicada. ABE - Projeto Fisher, Edgard Blücher.

http://adv-r.had.co.nz/Functions.html

http://www.burns-stat.com/pages/Tutor/R_inferno.pdf
